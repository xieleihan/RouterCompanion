<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta
        name="viewport"
        content="width=device-width, initial-scale=1.0"
    >
    <title>RouterCompanion APK æ„å»ºå™¨</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            max-width: 600px;
            margin: 50px auto;
            padding: 20px;
            background-color: #f5f5f5;
        }

        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #555;
        }

        input[type="text"],
        input[type="url"] {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
            box-sizing: border-box;
        }

        input:focus {
            outline: none;
            border-color: #4CAF50;
        }

        .btn {
            background-color: #4CAF50;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            width: 100%;
            margin-top: 10px;
        }

        .btn:hover {
            background-color: #45a049;
        }

        .btn:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }

        .status {
            margin-top: 20px;
            padding: 15px;
            border-radius: 5px;
            display: none;
        }

        .status.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .status.loading {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .example {
            font-size: 14px;
            color: #666;
            margin-top: 5px;
        }

        .recent-builds {
            margin-top: 30px;
            border-top: 1px solid #eee;
            padding-top: 20px;
        }

        .build-item {
            background: #f8f9fa;
            padding: 10px;
            margin: 5px 0;
            border-radius: 5px;
            border-left: 4px solid #4CAF50;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>ğŸš€ RouterCompanion APK æ„å»ºå™¨</h1>

        <form id="buildForm">
            <div class="form-group">
                <label for="domain">ç›®æ ‡åŸŸå:</label>
                <input
                    type="url"
                    id="domain"
                    name="domain"
                    required
                    placeholder="è¯·è¾“å…¥å®Œæ•´çš„URLåœ°å€"
                    value="http://game.localtest.echoing.cc:61007/login"
                >
                <div class="example">
                    ä¾‹å¦‚: https://example.com/login æˆ– http://192.168.1.1:8080/app
                </div>
            </div>

            <div class="form-group">
                <label for="token">GitHub Token:</label>
                <input
                    type="text"
                    id="token"
                    name="token"
                    required
                    placeholder="è¯·è¾“å…¥æ‚¨çš„GitHub Personal Access Token"
                >
                <div class="example">
                    éœ€è¦æœ‰ repo æƒé™çš„ GitHub Personal Access Token<br>
                    åˆ›å»ºæ–¹å¼: GitHub â†’ Settings â†’ Developer settings â†’ Personal access tokens
                </div>
            </div>

            <button
                type="submit"
                class="btn"
                id="buildBtn"
            >ğŸ”¨ å¼€å§‹æ„å»º APK</button>
        </form>

        <div
            id="status"
            class="status"
        ></div>

        <div class="recent-builds">
            <h3>ğŸ“Š æ„å»ºå†å²</h3>
            <div id="buildHistory"></div>
        </div>
    </div>

    <script>
        const GITHUB_OWNER = 'xieleihan';  // æ›¿æ¢ä¸ºæ‚¨çš„GitHubç”¨æˆ·å
        const GITHUB_REPO = 'RouterCompanion';   // æ›¿æ¢ä¸ºæ‚¨çš„ä»“åº“å

        // åŠ è½½ä¿å­˜çš„token
        document.addEventListener('DOMContentLoaded', function () {
            const savedToken = localStorage.getItem('github_token');
            if (savedToken) {
                document.getElementById('token').value = savedToken;
            }
            loadBuildHistory();
        });

        document.getElementById('buildForm').addEventListener('submit', async function (e) {
            e.preventDefault();

            const domain = document.getElementById('domain').value;
            const token = document.getElementById('token').value;
            const statusDiv = document.getElementById('status');
            const buildBtn = document.getElementById('buildBtn');

            // ä¿å­˜tokenåˆ°æœ¬åœ°å­˜å‚¨
            localStorage.setItem('github_token', token);

            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            buildBtn.disabled = true;
            buildBtn.textContent = 'ğŸ”„ æ„å»ºä¸­...';
            statusDiv.className = 'status loading';
            statusDiv.style.display = 'block';
            statusDiv.innerHTML = `
                <strong>ğŸš€ æ­£åœ¨å¯åŠ¨æ„å»º...</strong><br>
                ç›®æ ‡åŸŸå: ${domain}<br>
                <div style="margin-top: 10px;">
                    <div>â³ å‘é€æ„å»ºè¯·æ±‚...</div>
                </div>
            `;

            try {
                // è§¦å‘GitHub Actions
                const response = await fetch(`https://api.github.com/repos/${GITHUB_OWNER}/${GITHUB_REPO}/dispatches`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `token ${token}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        event_type: 'build-with-domain',
                        client_payload: {
                            domain: domain
                        }
                    })
                });

                if (response.ok) {
                    statusDiv.className = 'status success';
                    statusDiv.innerHTML = `
                        <strong>âœ… æ„å»ºè¯·æ±‚å·²å‘é€æˆåŠŸ!</strong><br>
                        ç›®æ ‡åŸŸå: ${domain}<br>
                        <div style="margin-top: 10px;">
                            <div>ğŸ”„ GitHub Actions æ­£åœ¨æ„å»ºä¸­...</div>
                            <div>ğŸ“¦ æ„å»ºå®Œæˆåå°†è‡ªåŠ¨å‘å¸ƒåˆ° Releases</div>
                            <div style="margin-top: 10px;">
                                <a href="https://github.com/${GITHUB_OWNER}/${GITHUB_REPO}/actions" target="_blank" style="color: #0366d6;">
                                    ğŸ”— æŸ¥çœ‹æ„å»ºè¿›åº¦
                                </a>
                                |
                                <a href="https://github.com/${GITHUB_OWNER}/${GITHUB_REPO}/releases" target="_blank" style="color: #0366d6;">
                                    ğŸ“‹ æŸ¥çœ‹å‘å¸ƒåˆ—è¡¨
                                </a>
                            </div>
                        </div>
                    `;

                    // æ·»åŠ åˆ°æ„å»ºå†å²
                    addToBuildHistory(domain);

                } else {
                    throw new Error(`HTTP ${response.status}: ${await response.text()}`);
                }

            } catch (error) {
                console.error('æ„å»ºè¯·æ±‚å¤±è´¥:', error);
                statusDiv.className = 'status error';
                statusDiv.innerHTML = `
                    <strong>âŒ æ„å»ºè¯·æ±‚å¤±è´¥</strong><br>
                    é”™è¯¯ä¿¡æ¯: ${error.message}<br>
                    <div style="margin-top: 10px;">
                        <div>ğŸ” è¯·æ£€æŸ¥:</div>
                        <div>â€¢ GitHub Token æ˜¯å¦æ­£ç¡®ä¸”æœ‰ repo æƒé™</div>
                        <div>â€¢ ç½‘ç»œè¿æ¥æ˜¯å¦æ­£å¸¸</div>
                        <div>â€¢ ä»“åº“åç§°æ˜¯å¦æ­£ç¡®</div>
                    </div>
                `;
            } finally {
                buildBtn.disabled = false;
                buildBtn.textContent = 'ğŸ”¨ å¼€å§‹æ„å»º APK';
            }
        });

        function addToBuildHistory(domain) {
            let history = JSON.parse(localStorage.getItem('build_history') || '[]');
            const now = new Date();
            history.unshift({
                domain: domain,
                timestamp: now.toISOString(),
                displayTime: now.toLocaleString('zh-CN')
            });

            // åªä¿ç•™æœ€è¿‘10æ¡è®°å½•
            history = history.slice(0, 10);
            localStorage.setItem('build_history', JSON.stringify(history));
            loadBuildHistory();
        }

        function loadBuildHistory() {
            const history = JSON.parse(localStorage.getItem('build_history') || '[]');
            const historyDiv = document.getElementById('buildHistory');

            if (history.length === 0) {
                historyDiv.innerHTML = '<div style="color: #666; text-align: center;">æš‚æ— æ„å»ºå†å²</div>';
                return;
            }

            historyDiv.innerHTML = history.map((item, index) => `
                <div class="build-item">
                    <strong>æ„å»º #${history.length - index}</strong><br>
                    ğŸŒ åŸŸå: ${item.domain}<br>
                    ğŸ• æ—¶é—´: ${item.displayTime}
                </div>
            `).join('');
        }

        // è‡ªåŠ¨éªŒè¯URLæ ¼å¼
        document.getElementById('domain').addEventListener('input', function (e) {
            const url = e.target.value;
            if (url && !url.match(/^https?:\/\/.+/)) {
                e.target.setCustomValidity('è¯·è¾“å…¥å®Œæ•´çš„URLï¼ŒåŒ…å« http:// æˆ– https://');
            } else {
                e.target.setCustomValidity('');
            }
        });
    </script>
</body>

</html>