<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta
        name="viewport"
        content="width=device-width, initial-scale=1.0"
    >
    <title>RouterCompanion APK Builder API</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            background-color: #0d1117;
            color: #c9d1d9;
            margin: 0;
            padding: 20px;
            line-height: 1.6;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: #161b22;
            border-radius: 8px;
            border: 1px solid #30363d;
            padding: 24px;
        }

        h1 {
            color: #58a6ff;
            border-bottom: 1px solid #30363d;
            padding-bottom: 10px;
        }

        .endpoint {
            background: #0d1117;
            border: 1px solid #30363d;
            border-radius: 6px;
            padding: 16px;
            margin: 16px 0;
        }

        .method {
            background: #238636;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }

        .url {
            font-family: monospace;
            color: #f85149;
            margin: 8px 0;
        }

        pre {
            background: #0d1117;
            border: 1px solid #30363d;
            border-radius: 6px;
            padding: 12px;
            overflow-x: auto;
            color: #e6edf3;
        }

        .response {
            margin-top: 12px;
        }

        .success {
            color: #3fb950;
        }

        .error {
            color: #f85149;
        }

        .info {
            color: #58a6ff;
        }

        .quick-build {
            background: #21262d;
            border: 1px solid #f85149;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }

        .build-form input,
        .build-form button {
            width: 100%;
            padding: 8px;
            margin: 8px 0;
            background: #0d1117;
            border: 1px solid #30363d;
            border-radius: 4px;
            color: #c9d1d9;
        }

        .build-form button {
            background: #238636;
            cursor: pointer;
        }

        .build-form button:hover {
            background: #2ea043;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>🚀 RouterCompanion APK Builder API</h1>

        <div class="info">
            <p>这是一个用于构建 RouterCompanion APK 的 API 接口文档和测试工具。</p>
        </div>

        <div class="endpoint">
            <h3><span class="method">POST</span> GitHub Repository Dispatch</h3>
            <div class="url">https://api.github.com/repos/{owner}/{repo}/dispatches</div>

            <h4>请求头:</h4>
            <pre>Authorization: token {github_token}
Accept: application/vnd.github.v3+json
Content-Type: application/json</pre>

            <h4>请求体:</h4>
            <pre>{
  "event_type": "build-with-domain",
  "client_payload": {
    "domain": "https://your-domain.com/login"
  }
}</pre>

            <div class="response">
                <h4>响应:</h4>
                <div class="success">✅ 成功 (204 No Content)</div>
                <div class="error">❌ 失败 (401/403/404)</div>
            </div>
        </div>

        <div class="quick-build">
            <h3>🔧 快速构建测试</h3>
            <p>在这里测试 API 调用：</p>

            <div class="build-form">
                <input
                    type="text"
                    id="owner"
                    placeholder="GitHub 用户名 (例如: xieleihan)"
                    value="xieleihan"
                >
                <input
                    type="text"
                    id="repo"
                    placeholder="仓库名 (例如: RouterCompanion)"
                    value="RouterCompanion"
                >
                <input
                    type="url"
                    id="domain"
                    placeholder="目标域名 (例如: https://example.com/login)"
                    value="http://game.localtest.echoing.cc:61007/login"
                >
                <input
                    type="password"
                    id="token"
                    placeholder="GitHub Personal Access Token"
                >
                <button onclick="triggerBuild()">🚀 触发构建</button>
            </div>

            <pre
                id="result"
                style="display: none;"
            ></pre>
        </div>

        <div class="endpoint">
            <h3>📋 使用示例</h3>

            <h4>cURL 示例:</h4>
            <pre>curl -X POST \
  -H "Authorization: token ghp_xxxxxxxxxxxx" \
  -H "Accept: application/vnd.github.v3+json" \
  -H "Content-Type: application/json" \
  -d '{
    "event_type": "build-with-domain",
    "client_payload": {
      "domain": "https://example.com/login"
    }
  }' \
  https://api.github.com/repos/xieleihan/RouterCompanion/dispatches</pre>

            <h4>JavaScript 示例:</h4>
            <pre>fetch('https://api.github.com/repos/xieleihan/RouterCompanion/dispatches', {
  method: 'POST',
  headers: {
    'Authorization': 'token ghp_xxxxxxxxxxxx',
    'Accept': 'application/vnd.github.v3+json',
    'Content-Type': 'application/json'
  },
  body: JSON.stringify({
    event_type: 'build-with-domain',
    client_payload: {
      domain: 'https://example.com/login'
    }
  })
}).then(response => {
  if (response.ok) {
    console.log('构建触发成功!');
  }
});</pre>

            <h4>Python 示例:</h4>
            <pre>import requests

response = requests.post(
    'https://api.github.com/repos/xieleihan/RouterCompanion/dispatches',
    headers={
        'Authorization': 'token ghp_xxxxxxxxxxxx',
        'Accept': 'application/vnd.github.v3+json',
        'Content-Type': 'application/json'
    },
    json={
        'event_type': 'build-with-domain',
        'client_payload': {
            'domain': 'https://example.com/login'
        }
    }
)

if response.status_code == 204:
    print('构建触发成功!')
else:
    print(f'错误: {response.status_code}')</pre>
        </div>

        <div class="endpoint">
            <h3>🔗 相关链接</h3>
            <ul>
                <li><a
                        href="https://github.com/xieleihan/RouterCompanion/actions"
                        target="_blank"
                    >🔄 查看构建状态</a></li>
                <li><a
                        href="https://github.com/xieleihan/RouterCompanion/releases"
                        target="_blank"
                    >📦 下载 APK</a></li>
                <li><a
                        href="https://github.com/settings/tokens"
                        target="_blank"
                    >🔑 创建 GitHub Token</a></li>
            </ul>
        </div>

        <div class="info">
            <h3>📝 注意事项</h3>
            <ul>
                <li>GitHub Token 需要具有 <code>repo</code> 权限</li>
                <li>构建过程大约需要 3-5 分钟</li>
                <li>构建完成后会自动创建 GitHub Release</li>
                <li>APK 文件名格式：<code>apk-{日期}-{域名}-{哈希}-v{版本号}</code></li>
            </ul>
        </div>
    </div>

    <script>
        async function triggerBuild() {
            const owner = document.getElementById('owner').value;
            const repo = document.getElementById('repo').value;
            const domain = document.getElementById('domain').value;
            const token = document.getElementById('token').value;
            const resultDiv = document.getElementById('result');

            if (!owner || !repo || !domain || !token) {
                alert('请填写所有字段');
                return;
            }

            resultDiv.style.display = 'block';
            resultDiv.textContent = '⏳ 发送构建请求...';
            resultDiv.className = '';

            try {
                const response = await fetch(`https://api.github.com/repos/${owner}/${repo}/dispatches`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `token ${token}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        event_type: 'build-with-domain',
                        client_payload: {
                            domain: domain
                        }
                    })
                });

                const timestamp = new Date().toLocaleString('zh-CN');

                if (response.status === 204) {
                    resultDiv.innerHTML = `✅ 构建请求发送成功! (${timestamp})

📍 目标域名: ${domain}
🔗 构建状态: https://github.com/${owner}/${repo}/actions
📦 发布页面: https://github.com/${owner}/${repo}/releases

⏳ 请等待 3-5 分钟查看构建结果`;
                    resultDiv.style.color = '#3fb950';
                } else {
                    const errorText = await response.text();
                    resultDiv.innerHTML = `❌ 构建请求失败 (${timestamp})

HTTP ${response.status}: ${response.statusText}
${errorText}

🔍 可能原因:
• GitHub Token 无效或权限不足
• 仓库名称错误
• 网络连接问题`;
                    resultDiv.style.color = '#f85149';
                }

            } catch (error) {
                resultDiv.innerHTML = `❌ 请求异常 (${new Date().toLocaleString('zh-CN')})

错误信息: ${error.message}

🔍 请检查网络连接和输入信息`;
                resultDiv.style.color = '#f85149';
            }
        }

        // 自动保存输入内容到 localStorage
        ['owner', 'repo', 'domain', 'token'].forEach(id => {
            const element = document.getElementById(id);
            // 加载保存的值（除了token）
            if (id !== 'token') {
                const saved = localStorage.getItem(`api_${id}`);
                if (saved) element.value = saved;
            }

            // 保存输入值
            element.addEventListener('input', () => {
                if (id !== 'token') {  // 不保存token到localStorage
                    localStorage.setItem(`api_${id}`, element.value);
                }
            });
        });
    </script>
</body>

</html>