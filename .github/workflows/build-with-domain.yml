name: Build APK with Custom Domain

on:
    repository_dispatch:
        types: [build-with-domain]
    workflow_dispatch:
        inputs:
            domain:
                description: "Custom domain for webView"
                required: true
                type: string
                default: "http://game.localtest.echoing.cc:61007/login"

jobs:
    build:
        runs-on: ubuntu-latest

        steps:
            - name: Checkout source
              uses: actions/checkout@v4
              with:
                  token: ${{ secrets.GITHUB_TOKEN }}

            - name: Set up JDK 17
              uses: actions/setup-java@v4
              with:
                  distribution: "temurin"
                  java-version: "17"

            - name: Set up Android SDK
              uses: android-actions/setup-android@v3

            - name: Get version number
              id: version
              run: |
                  # è¯»å–å½“å‰ç‰ˆæœ¬å·ï¼Œå¦‚æœæ–‡ä»¶ä¸å­˜åœ¨åˆ™ä»1å¼€å§‹
                  if [ -f "version.txt" ]; then
                    CURRENT_VERSION=$(cat version.txt)
                  else
                    CURRENT_VERSION=0
                  fi
                  NEW_VERSION=$((CURRENT_VERSION + 1))
                  echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT
                  echo $NEW_VERSION > version.txt
                  echo "å½“å‰ç‰ˆæœ¬å·: $NEW_VERSION"

            - name: Update domain in MainActivity
              run: |
                  DOMAIN="${{ github.event.client_payload.domain || github.event.inputs.domain }}"
                  echo "æ›´æ–°åŸŸåä¸º: $DOMAIN"

                  # å¤‡ä»½åŸæ–‡ä»¶
                  cp app/src/main/java/com/southaki/gamemarket/MainActivity.java MainActivity.java.backup

                  # ä½¿ç”¨sedæ›¿æ¢åŸŸå
                  sed -i 's|webView\.loadUrl("[^"]*");|webView.loadUrl("'"$DOMAIN"'");|g' app/src/main/java/com/southaki/gamemarket/MainActivity.java

                  # éªŒè¯ä¿®æ”¹
                  echo "ä¿®æ”¹åçš„loadUrlè¡Œï¼š"
                  grep "webView.loadUrl" app/src/main/java/com/southaki/gamemarket/MainActivity.java

            - name: Grant Gradle permissions
              run: chmod +x ./gradlew

            - name: Build Debug APK
              run: ./gradlew assembleDebug

            - name: Generate release info
              id: release_info
              run: |
                  DATE=$(date +"%Y%m%d")
                  DOMAIN="${{ github.event.client_payload.domain || github.event.inputs.domain }}"
                  # æå–åŸŸåçš„ä¸»æœºéƒ¨åˆ†ä½œä¸ºæ ‡è¯†
                  DOMAIN_CLEAN=$(echo "$DOMAIN" | sed 's|http[s]*://||g' | sed 's|/.*||g' | sed 's|:.*||g')
                  HASH=$(echo "$DOMAIN" | sha256sum | cut -c1-8)
                  VERSION="${{ steps.version.outputs.version }}"

                  RELEASE_TITLE="apk-${DATE}-${DOMAIN_CLEAN}-${HASH}-v${VERSION}"
                  APK_NAME="app-${DOMAIN_CLEAN}-v${VERSION}.apk"

                  echo "release_title=$RELEASE_TITLE" >> $GITHUB_OUTPUT
                  echo "apk_name=$APK_NAME" >> $GITHUB_OUTPUT
                  echo "domain_clean=$DOMAIN_CLEAN" >> $GITHUB_OUTPUT

                  echo "å‘å¸ƒæ ‡é¢˜: $RELEASE_TITLE"
                  echo "APKåç§°: $APK_NAME"

            - name: Rename APK
              run: |
                  mv app/build/outputs/apk/debug/app-debug.apk app/build/outputs/apk/debug/${{ steps.release_info.outputs.apk_name }}

            - name: Commit version update
              run: |
                  git config --local user.email "action@github.com"
                  git config --local user.name "GitHub Action"
                  git add version.txt
                  git commit -m "Update version to ${{ steps.version.outputs.version }}" || exit 0

            - name: Push changes
              uses: ad-m/github-push-action@master
              with:
                  github_token: ${{ secrets.GITHUB_TOKEN }}
                  branch: main

            - name: Create GitHub Release
              uses: softprops/action-gh-release@v2
              with:
                  name: "${{ steps.release_info.outputs.release_title }}"
                  tag_name: "v${{ steps.version.outputs.version }}"
                  body: |
                      ğŸš€ **è‡ªåŠ¨æ„å»ºå‘å¸ƒ**

                      ğŸ“… **æ„å»ºæ—¥æœŸ**: $(date +"%Y-%m-%d %H:%M:%S")
                      ğŸŒ **ç›®æ ‡åŸŸå**: ${{ github.event.client_payload.domain || github.event.inputs.domain }}
                      ğŸ·ï¸ **ç‰ˆæœ¬å·**: v${{ steps.version.outputs.version }}
                      ğŸ”– **åŸŸåæ ‡è¯†**: ${{ steps.release_info.outputs.domain_clean }}

                      ---

                      è¿™æ˜¯é€šè¿‡APIè‡ªåŠ¨æ„å»ºçš„APKï¼Œå·²é…ç½®ä¸ºè®¿é—®æŒ‡å®šçš„åŸŸåã€‚

                  files: app/build/outputs/apk/debug/${{ steps.release_info.outputs.apk_name }}
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

            - name: Upload APK as Artifact
              uses: actions/upload-artifact@v4
              with:
                  name: ${{ steps.release_info.outputs.apk_name }}
                  path: app/build/outputs/apk/debug/${{ steps.release_info.outputs.apk_name }}
